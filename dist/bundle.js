(()=>{window.onload=function(){window.__cam=document.querySelector("#cam"),handleTabModify();let t=document.querySelector(".btn-add-location"),e=document.querySelector(".submenu");t&&e&&t.addEventListener("click",()=>{e.classList.toggle("hidden")}),handleCloseSlideBar();let n=document.querySelector("a-scene");n.hasLoaded?(console.log("Scene has already loaded"),messenger&&messenger.start()):n.addEventListener("loaded",()=>{console.log("Scene loaded event fired"),messenger&&messenger.start()})};AFRAME.components["look-controls"].Component.prototype.onTouchMove=function(t){this.touchStarted&&this.data.touchEnabled&&setTimeout(()=>{this.pitchObject.rotation.x+=Math.PI*(t.touches[0].pageY-this.touchStart.y)/this.el.sceneEl.canvas.clientHeight*.5,this.yawObject.rotation.y+=Math.PI*(t.touches[0].pageX-this.touchStart.x)/this.el.sceneEl.canvas.clientWidth*.3,this.pitchObject.rotation.x=Math.max(Math.PI/-2,Math.min(Math.PI/2,this.pitchObject.rotation.x)),this.touchStart={x:t.touches[0].pageX,y:t.touches[0].pageY}},150)};AFRAME.registerComponent("custom-look",{init:function(){let t=this.el;t.addEventListener("update-xy",function(e){let n=t.components["look-controls"];n&&(n.pitchObject.rotation.x=e.detail.x,n.yawObject.rotation.y=e.detail.y)})},getCurrentRotation:function(){let t=this.el.components["look-controls"];if(t)return{x:t.pitchObject.rotation.x,y:t.yawObject.rotation.y}}});AFRAME.registerComponent("handle-drag-and-drop",{schema:{axis:{type:"string",default:"x"},targetEl:{type:"selector",default:"#targetBox"}},init:function(){let t=this.el,e=this.data;this.isHolding=!1,this.isHoldThisObject=!1,this.targetEl=e.targetEl,this.handleMovement(t)},handleMovement:function(t){t.addEventListener("mouseenter",e=>{this.el.parentElement.getAttribute("visible")&&(window.__holdingAxis&&window.__holdingAxis!==this.data.axis||window.__holdingTarget&&window.__holdingTarget!==this.el||(this.isHoldThisObject=!0,window.__cam.components["look-controls"].pause(),window.__holdingAxis=this.data.axis,window.__holdingTarget=this.el))}),window.addEventListener("mousemove",e=>{if(!this.isHoldThisObject||!this.isHolding||window.__holdingTarget!==this.el)return;let n=document.querySelector("#cam").object3D,o=this.targetEl.object3D,s=.03,a=new THREE.Vector3;n.getWorldDirection(a);let i=new THREE.Vector3().crossVectors(n.up,a).normalize(),u=n.up.clone().normalize(),c=new THREE.Vector3(1,0,0).applyQuaternion(o.quaternion).normalize(),m=new THREE.Vector3(0,1,0).applyQuaternion(o.quaternion).normalize(),g=new THREE.Vector3(0,0,1).applyQuaternion(o.quaternion).normalize(),h=new THREE.Vector3().addScaledVector(i,e.movementX*s).addScaledVector(u,-e.movementY*s),d=this.data.axis==="x"?c:this.data.axis==="y"?m:g,y=d.clone().multiplyScalar(h.dot(d));o.position.add(y),this.targetEl.setAttribute("position",o.position),document.dispatchEvent(new CustomEvent("position-change",{detail:{id:this.targetEl.id,x:o.position.x,y:o.position.y,z:o.position.z}}))}),window.addEventListener("mouseup",e=>{this.isHolding=!1,this.isHoldThisObject=!1,window.__cam.components["look-controls"].play(),window.__holdingAxis=null,window.__holdingTarget=null}),window.addEventListener("mousedown",e=>{this.isHolding=!0})},getCurrentCameraDirection:function(){let t=document.querySelector("#cam"),e=new THREE.Vector3;return t.object3D.getWorldDirection(e),e},getCameraRotation:function(){return document.querySelector("#cam").getAttribute("rotation")},handleXYZMovement:function(){let t=this.getCurrentCameraDirection();return{xDirect:this.getCameraRotation().y>=90?-1:1,yDirect:1,zDirect:t.x>=0?1:-1}}});function l({id:t,rotation:e,axis:n,color:o}){let s=document.createElement("a-entity");s.setAttribute("handle-drag-and-drop",`axis: ${n}; targetEl: #${t}`),s.setAttribute("class","axis"),s.setAttribute("rotation",e);let a=document.createElement("a-entity");a.setAttribute("geometry","primitive: cylinder; radius: 0.005; height: 1.2"),a.setAttribute("position","0 0.6 0"),a.setAttribute("material",`color: ${o}`),a.setAttribute("class","axis");let i=document.createElement("a-entity");return i.setAttribute("geometry","primitive: cone; radiusBottom: 0.06; height: 0.2"),i.setAttribute("position","0 1.3 0"),i.setAttribute("material",`color: ${o}`),i.setAttribute("class","axis"),s.appendChild(a),s.appendChild(i),s}function b(t="targetBox",e="0 1.25 -3"){let n=document.getElementById(t);if(!n)return console.error(`Element with id "${t}" not found.`),!1;n.setAttribute("position",e),n.setAttribute("rotation","0 0 0");let o=document.createElement("a-entity");return o.setAttribute("class","axis-helper"),o.appendChild(l({id:t,axis:"x",color:"#ff4444",rotation:"0 0 -90"})),o.appendChild(l({id:t,axis:"y",color:"#44ff44",rotation:"0 0 0"})),o.appendChild(l({id:t,axis:"z",color:"#4444ff",rotation:"90 0 0"})),o.setAttribute("visible",!1),n.appendChild(o),!0}AFRAME.registerComponent("axis-helper",{init:function(){let t=this.el;b(t.id),this.isSelected=!1}});AFRAME.registerComponent("axis-selector",{init:function(){let t=this.el,e=t.parentElement;t.addEventListener("click",n=>{console.log("Click axis selector");let o=e.querySelector(".axis-helper");if(console.log("Group axis:",t),o){let s=!o.getAttribute("visible");o.setAttribute("visible",s);let a=o.querySelectorAll(".axis");if(s){if(window.__selectTargetId){let i=window.__selectTargetId;i.querySelectorAll(".axis").forEach(c=>{c.classList.toggle("clickable",!1)}),setTimeout(()=>{i.setAttribute("visible",!1)},0)}window.__selectTargetId=o,a.forEach(i=>{i.classList.toggle("clickable",!0)}),openCustomValuePop(),setCustomObjectTab(e.id,{posX:e.getAttribute("position").x,posY:e.getAttribute("position").y,posZ:e.getAttribute("position").z,rotX:e.getAttribute("rotation").x,rotY:e.getAttribute("rotation").y,rotZ:e.getAttribute("rotation").z,scaleX:e.getAttribute("scale").x,scaleY:e.getAttribute("scale").y,scaleZ:e.getAttribute("scale").z})}else window.__selectTargetId=null,a.forEach(i=>{i.classList.toggle("clickable",!1)})}})}});var r=new TabMessenger("scene");function p(t,e="success",n=3e3){let o=document.createElement("div");o.className=`z-[120] fixed bottom-16 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded shadow-lg z-50 ${e==="success"?"bg-green-500":"bg-red-500 text-white"} `,o.textContent=t,document.body.appendChild(o),console.log("Toast message:",t),setTimeout(()=>{document.body.removeChild(o)},n)}r.start=function(){r.on("LOAD_SCENE",t=>{loadScene(t.data)}),r.send("SCENE_READY",{version:"1.0.0",fps:60}),r.on("LOAD_DATA",t=>{p("\u0110ang t\u1EA3i c\u1EA3nh...","success",2e3),console.log("LOAD_DATA",t),t.data&&(console.log("data load:",t.data),loadScene(t.data.scene),loadLocations(t.data.locations||[]),loadHotspots(t.data.hotspots||[]))}),r.on("ACK_ACTION",t=>{p(t.message||"Action completed",t.type,4e3),r.ack=null}),window.addEventListener("beforeunload",()=>{r.send("SCENE_CLOSED")})};document.addEventListener("add-hotspot",t=>{let e=t.detail,n=createAxisEntity(e);document.querySelector("a-scene").appendChild(n),setTimeout(()=>{findHotspot(e.id)},300)});window.addEventListener("keydown",t=>{t.altKey&&t.key.toLowerCase()==="q"&&(t.preventDefault(),document.getElementById("back-parent-btn").click())});})();
